<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weight Loss Journey Tracker</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      background: #0a0e1a;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px 20px;
      background: linear-gradient(135deg, #1a1f35 0%, #0f1421 100%);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .header h1 {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 8px;
      color: #ffffff;
    }

    .header .goal {
      font-size: 18px;
      color: #10b981;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .header .date {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.5);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #1a1f35;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
    }

    .stat-card .label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 800;
      color: #10b981;
    }

    .section {
      background: #1a1f35;
      padding: 28px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .section h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #ffffff;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .input-group input {
      width: 100%;
      padding: 14px 16px;
      background: #0f1421;
      border: 2px solid #2d3548;
      border-radius: 10px;
      color: #ffffff;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: #10b981;
    }

    .input-group textarea {
      width: 100%;
      padding: 14px 16px;
      background: #0f1421;
      border: 2px solid #2d3548;
      border-radius: 10px;
      color: #ffffff;
      font-size: 16px;
      min-height: 80px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.3s ease;
    }

    .input-group textarea:focus {
      outline: none;
      border-color: #10b981;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #0f1421;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 16px;
    }

    .checkbox-group:hover {
      background: #151b2e;
    }

    .checkbox-group input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: #10b981;
      margin-right: 14px;
    }

    .checkbox-group label {
      font-size: 17px;
      color: #ffffff;
      cursor: pointer;
      user-select: none;
      flex: 1;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: #10b981;
      color: #ffffff;
    }

    .btn-secondary {
      background: #3b82f6;
      color: #ffffff;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: #0f1421;
      border-radius: 20px;
      overflow: hidden;
      margin-top: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      border-radius: 20px;
      transition: width 0.5s ease;
    }

    .spinner {
      border: 3px solid rgba(16, 185, 129, 0.3);
      border-top-color: #10b981;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .loading p {
      margin-top: 20px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 16px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .workout-days {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .day-badge {
      padding: 8px 16px;
      background: #0f1421;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
    }

    .day-badge.active {
      background: #10b981;
      color: #ffffff;
    }

    @media (max-width: 640px) {
      .header h1 {
        font-size: 28px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card .value {
        font-size: 28px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- Loading Screen -->
   <div id="loading-screen" class="loading">
    <div class="spinner"></div>
    <p>Loading your fitness journey...</p>
   </div><!-- Main Content -->
   <div id="main-content" style="display: none;"><!-- Header -->
    <header class="header">
     <h1 id="app-title">Weight Loss Journey</h1>
     <div id="goal-text" class="goal">
      üéØ Goal: 100kg ‚Üí 90kg in 2 months
     </div>
     <div id="current-date" class="date"></div>
     <div class="workout-days"><span class="day-badge" id="day-mon">MON</span> <span class="day-badge" id="day-tue">TUE</span> <span class="day-badge" id="day-wed">WED</span> <span class="day-badge" id="day-thu">THU</span> <span class="day-badge" id="day-fri">FRI</span> <span class="day-badge">SAT</span> <span class="day-badge">SUN</span>
     </div>
    </header><!-- Stats Cards -->
    <div class="stats-grid">
     <div class="stat-card">
      <div class="label">
       Current Weight
      </div>
      <div class="value" id="stat-weight">
       --
      </div>
      <div class="progress-bar">
       <div class="progress-fill" id="weight-progress" style="width: 0%"></div>
      </div>
     </div>
     <div class="stat-card">
      <div class="label">
       Today's Calories
      </div>
      <div class="value" id="stat-calories" style="color: #3b82f6;">
       --
      </div>
     </div>
     <div class="stat-card">
      <div class="label">
       Workout Duration
      </div>
      <div class="value" id="stat-duration" style="color: #f59e0b;">
       --
      </div>
     </div>
    </div><!-- Today's Weight -->
    <section class="section">
     <h2>üìä Daily Check-in</h2>
     <div class="input-group"><label for="input-weight">Current Weight (kg)</label> <input type="number" id="input-weight" placeholder="e.g., 98.5" step="0.1" min="50" max="150">
     </div>
    </section><!-- Workout Section -->
    <section class="section">
     <h2>üí™ Workout (Mon-Fri: 1.5h minimum)</h2>
     <div class="checkbox-group"><input type="checkbox" id="input-workout-completed"> <label for="input-workout-completed">‚úÖ Workout completed today</label>
     </div>
     <div class="input-group"><label for="input-workout-duration">Workout Duration (minutes)</label> <input type="number" id="input-workout-duration" placeholder="e.g., 90" min="0" max="300">
     </div>
    </section><!-- Nutrition Section -->
    <section class="section">
     <h2>üçΩÔ∏è Nutrition</h2>
     <div class="input-group"><label for="input-calories">Calories Consumed</label> <input type="number" id="input-calories" placeholder="e.g., 1800" min="0" max="5000">
     </div>
     <div class="input-group"><label for="input-protein">Protein (grams)</label> <input type="number" id="input-protein" placeholder="e.g., 150" min="0" max="500">
     </div>
     <div class="input-group"><label for="input-water">Water Intake (liters)</label> <input type="number" id="input-water" placeholder="e.g., 3.5" step="0.1" min="0" max="10">
     </div>
    </section><!-- Activity & Recovery -->
    <section class="section">
     <h2>üèÉ Activity &amp; Recovery</h2>
     <div class="input-group"><label for="input-steps">Daily Steps</label> <input type="number" id="input-steps" placeholder="e.g., 10000" min="0" max="50000">
     </div>
     <div class="input-group"><label for="input-sleep">Sleep Duration (hours)</label> <input type="number" id="input-sleep" placeholder="e.g., 7.5" step="0.5" min="0" max="24">
     </div>
    </section><!-- Notes -->
    <section class="section">
     <h2>üìù Daily Notes</h2>
     <div class="input-group"><label for="input-notes">How do you feel? Any observations?</label> <textarea id="input-notes" placeholder="Energy levels, motivation, challenges..."></textarea>
     </div>
    </section><!-- Save Button --> <button id="btn-save" class="btn btn-primary">üíæ Save Today's Progress</button> <!-- Export Button -->
    <div style="margin-top: 16px;"><button id="btn-export" class="btn btn-secondary">üìä Export Progress to CSV</button>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Weight Loss Journey",
      goal_text: "üéØ Goal: 100kg ‚Üí 90kg in 2 months",
      background_color: "#0a0e1a",
      surface_color: "#1a1f35",
      text_color: "#ffffff",
      primary_action_color: "#10b981",
      secondary_action_color: "#3b82f6",
      font_family: "system-ui",
      font_size: 16
    };

    const STARTING_WEIGHT = 100;
    const GOAL_WEIGHT = 90;

    let currentRecord = null;
    let allRecords = [];
    let isSaving = false;

    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function getTodayDayOfWeek() {
      return new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
    }

    function highlightWorkoutDays() {
      const today = getTodayDayOfWeek();
      const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      
      // Highlight Monday (1) to Friday (5)
      for (let i = 1; i <= 5; i++) {
        const dayEl = document.getElementById(`day-${days[i]}`);
        if (dayEl && i === today) {
          dayEl.classList.add('active');
        }
      }
    }

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toast.style.backgroundColor = isError ? '#ef4444' : '#10b981';
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function updateStats() {
      if (!currentRecord) {
        document.getElementById('stat-weight').textContent = '--';
        document.getElementById('stat-calories').textContent = '--';
        document.getElementById('stat-duration').textContent = '--';
        document.getElementById('weight-progress').style.width = '0%';
        return;
      }

      // Update weight
      if (currentRecord.current_weight) {
        document.getElementById('stat-weight').textContent = `${currentRecord.current_weight} kg`;
        
        // Calculate progress
        const totalLoss = STARTING_WEIGHT - GOAL_WEIGHT;
        const currentLoss = STARTING_WEIGHT - currentRecord.current_weight;
        const progressPercent = Math.min(100, Math.max(0, (currentLoss / totalLoss) * 100));
        document.getElementById('weight-progress').style.width = `${progressPercent}%`;
      }

      // Update calories
      if (currentRecord.calories_consumed) {
        document.getElementById('stat-calories').textContent = `${currentRecord.calories_consumed} kcal`;
      } else {
        document.getElementById('stat-calories').textContent = '--';
      }

      // Update workout duration
      if (currentRecord.workout_duration) {
        const hours = Math.floor(currentRecord.workout_duration / 60);
        const mins = currentRecord.workout_duration % 60;
        if (hours > 0) {
          document.getElementById('stat-duration').textContent = `${hours}h ${mins}m`;
        } else {
          document.getElementById('stat-duration').textContent = `${mins}m`;
        }
      } else {
        document.getElementById('stat-duration').textContent = '--';
      }
    }

    function populateForm() {
      if (!currentRecord) {
        document.getElementById('input-weight').value = '';
        document.getElementById('input-workout-completed').checked = false;
        document.getElementById('input-workout-duration').value = '';
        document.getElementById('input-calories').value = '';
        document.getElementById('input-protein').value = '';
        document.getElementById('input-water').value = '';
        document.getElementById('input-steps').value = '';
        document.getElementById('input-sleep').value = '';
        document.getElementById('input-notes').value = '';
        return;
      }

      document.getElementById('input-weight').value = currentRecord.current_weight || '';
      document.getElementById('input-workout-completed').checked = currentRecord.workout_completed || false;
      document.getElementById('input-workout-duration').value = currentRecord.workout_duration || '';
      document.getElementById('input-calories').value = currentRecord.calories_consumed || '';
      document.getElementById('input-protein').value = currentRecord.protein_grams || '';
      document.getElementById('input-water').value = currentRecord.water_liters || '';
      document.getElementById('input-steps').value = currentRecord.steps || '';
      document.getElementById('input-sleep').value = currentRecord.sleep_hours || '';
      document.getElementById('input-notes').value = currentRecord.notes || '';
    }

    async function saveProgress() {
      if (isSaving) return;

      isSaving = true;
      const btn = document.getElementById('btn-save');
      btn.disabled = true;
      btn.textContent = 'üíæ Saving...';

      const data = {
        date: getTodayDate(),
        current_weight: parseFloat(document.getElementById('input-weight').value) || null,
        workout_completed: document.getElementById('input-workout-completed').checked,
        workout_duration: parseInt(document.getElementById('input-workout-duration').value) || null,
        calories_consumed: parseInt(document.getElementById('input-calories').value) || null,
        protein_grams: parseInt(document.getElementById('input-protein').value) || null,
        water_liters: parseFloat(document.getElementById('input-water').value) || null,
        steps: parseInt(document.getElementById('input-steps').value) || null,
        sleep_hours: parseFloat(document.getElementById('input-sleep').value) || null,
        notes: document.getElementById('input-notes').value || ''
      };

      let result;
      if (!currentRecord) {
        result = await window.dataSdk.create(data);
      } else {
        result = await window.dataSdk.update({ ...currentRecord, ...data });
      }

      if (result.isOk) {
        showToast('Progress saved successfully! üí™');
      } else {
        showToast('Failed to save. Please try again.', true);
      }

      btn.disabled = false;
      btn.textContent = 'üíæ Save Today\'s Progress';
      isSaving = false;
    }

    async function exportToCSV() {
      const btn = document.getElementById('btn-export');
      btn.disabled = true;
      btn.textContent = 'üìä Exporting...';

      setTimeout(() => {
        if (allRecords.length === 0) {
          showToast('No data to export yet!', true);
          btn.disabled = false;
          btn.textContent = 'üìä Export Progress to CSV';
          return;
        }

        const headers = ['Date', 'Weight (kg)', 'Workout Done', 'Duration (min)', 'Calories', 'Protein (g)', 'Water (L)', 'Steps', 'Sleep (h)', 'Notes'];
        const rows = [headers.join(',')];

        allRecords.forEach(record => {
          const row = [
            record.date,
            record.current_weight || '',
            record.workout_completed ? 'Yes' : 'No',
            record.workout_duration || '',
            record.calories_consumed || '',
            record.protein_grams || '',
            record.water_liters || '',
            record.steps || '',
            record.sleep_hours || '',
            `"${(record.notes || '').replace(/"/g, '""')}"`
          ];
          rows.push(row.join(','));
        });

        const csvContent = rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fitness-journey-${getTodayDate()}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);

        showToast('CSV exported successfully! üìä');
        btn.disabled = false;
        btn.textContent = 'üìä Export Progress to CSV';
      }, 500);
    }

    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        const today = getTodayDate();
        const todayRecord = data.find(r => r.date === today);

        currentRecord = todayRecord || null;
        
        populateForm();
        updateStats();

        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
      }
    };

    async function onConfigChange(config) {
      const font = config.font_family || defaultConfig.font_family;
      const fontStack = `${font}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      const baseSize = config.font_size || defaultConfig.font_size;

      document.body.style.background = config.background_color || defaultConfig.background_color;
      document.body.style.fontFamily = fontStack;

      const sections = document.querySelectorAll('.section, .header');
      sections.forEach(section => {
        section.style.background = config.surface_color || defaultConfig.surface_color;
      });

      const statCards = document.querySelectorAll('.stat-card');
      statCards.forEach(card => {
        card.style.background = config.surface_color || defaultConfig.surface_color;
      });

      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('app-title').style.fontSize = `${baseSize * 2.25}px`;

      document.getElementById('goal-text').textContent = config.goal_text || defaultConfig.goal_text;
      document.getElementById('goal-text').style.fontSize = `${baseSize * 1.125}px`;
    }

    async function init() {
      document.getElementById('current-date').textContent = formatDate(getTodayDate());
      highlightWorkoutDays();

      const initResult = await window.dataSdk.init(dataHandler);
      
      if (!initResult.isOk) {
        showToast('Failed to initialize. Please refresh.', true);
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        return;
      }

      document.getElementById('btn-save').addEventListener('click', saveProgress);
      document.getElementById('btn-export').addEventListener('click', exportToCSV);

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["goal_text", config.goal_text || defaultConfig.goal_text]
          ])
        });
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a617de13529cfef',t:'MTc2NDQxMjg3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>